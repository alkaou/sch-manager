<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Surveillance des √âv√©nements</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .event-item {
            background: #e9ecef;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .event-item.warning {
            border-left-color: #ffc107;
        }
        .event-item.success {
            border-left-color: #28a745;
        }
        .event-item.danger {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test de Surveillance des √âv√©nements</h1>
        <p>Cette page permet de tester le syst√®me de surveillance automatique des √©v√©nements.</p>
        
        <div>
            <h3>Actions de Test</h3>
            <button class="button success" onclick="createTestEvents()">Cr√©er des √âv√©nements de Test</button>
            <button class="button" onclick="checkEventStatus()">V√©rifier le Statut</button>
            <button class="button danger" onclick="cleanupTestEvents()">Nettoyer les Tests</button>
            <button class="button" onclick="clearLog()">Effacer le Log</button>
        </div>
        
        <div>
            <h3>√âv√©nements de Test Cr√©√©s</h3>
            <div id="events-list"></div>
        </div>
        
        <div>
            <h3>Log de Surveillance</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // Fonction pour logger les messages
        function logMessage(message, type = 'info') {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Fonction pour effacer le log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Fonction pour cr√©er des √©v√©nements de test
        async function createTestEvents() {
            logMessage('üß™ Cr√©ation d\'√©v√©nements de test...', 'info');

            console.log(window);
            
            const now = new Date();
            
            // √âv√©nements de test avec diff√©rents d√©lais
            const testEvents = [
                {
                    id: 'test-event-25min',
                    title: 'R√©union importante dans 25 min',
                    description: 'R√©union avec l\'√©quipe de d√©veloppement',
                    type: 'conference',
                    startDate: new Date(now.getTime() + 25 * 60 * 1000).toISOString().split('T')[0],
                    startTime: new Date(now.getTime() + 25 * 60 * 1000).toTimeString().slice(0, 5),
                    endDate: new Date(now.getTime() + 85 * 60 * 1000).toISOString().split('T')[0],
                    endTime: new Date(now.getTime() + 85 * 60 * 1000).toTimeString().slice(0, 5),
                    status: 'pending',
                    notificationsIsSended: false,
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString(),
                    validation: null
                },
                {
                    id: 'test-event-15min',
                    title: 'Cours de math√©matiques dans 15 min',
                    description: 'Cours de math√©matiques avanc√©es',
                    type: 'exam_period',
                    startDate: new Date(now.getTime() + 15 * 60 * 1000).toISOString().split('T')[0],
                    startTime: new Date(now.getTime() + 15 * 60 * 1000).toTimeString().slice(0, 5),
                    endDate: new Date(now.getTime() + 75 * 60 * 1000).toISOString().split('T')[0],
                    endTime: new Date(now.getTime() + 75 * 60 * 1000).toTimeString().slice(0, 5),
                    status: 'pending',
                    notificationsIsSended: false,
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString(),
                    validation: null
                },
                {
                    id: 'test-event-5min',
                    title: '√âv√©nement urgent dans 5 min',
                    description: '√âv√©nement qui doit notifier imm√©diatement',
                    type: 'workshop',
                    startDate: new Date(now.getTime() + 5 * 60 * 1000).toISOString().split('T')[0],
                    startTime: new Date(now.getTime() + 5 * 60 * 1000).toTimeString().slice(0, 5),
                    endDate: new Date(now.getTime() + 65 * 60 * 1000).toISOString().split('T')[0],
                    endTime: new Date(now.getTime() + 65 * 60 * 1000).toTimeString().slice(0, 5),
                    status: 'pending',
                    notificationsIsSended: false,
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString(),
                    validation: null
                }
            ];
            
            try {
                // Sauvegarder dans la base de donn√©es Electron
                if (window.electron && window.electron.getDatabase && window.electron.saveDatabase) {
                    const database = await window.electron.getDatabase();
                    
                    if (!database.events) {
                        database.events = [];
                    }
                    
                    // Supprimer les anciens √©v√©nements de test
                    database.events = database.events.filter(event => 
                        !event.id.startsWith('test-event-')
                    );
                    
                    // Ajouter les nouveaux √©v√©nements de test
                    database.events.push(...testEvents);
                    
                    await window.electron.saveDatabase(database);
                    logMessage('‚úÖ √âv√©nements de test sauvegard√©s dans la base de donn√©es', 'success');
                } else {
                    logMessage('‚ö†Ô∏è API Electron non disponible', 'warning');
                }
                
                // Afficher les √©v√©nements cr√©√©s
                displayEvents(testEvents);
                
            } catch (error) {
                logMessage(`‚ùå Erreur lors de la cr√©ation des √©v√©nements: ${error.message}`, 'error');
            }
        }

        // Fonction pour afficher les √©v√©nements
        function displayEvents(events) {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            events.forEach(event => {
                const eventTime = new Date(`${event.startDate}T${event.startTime}`);
                const now = new Date();
                const minutesDiff = Math.floor((eventTime.getTime() - now.getTime()) / (1000 * 60));
                
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                if (minutesDiff <= 5) eventDiv.className += ' danger';
                else if (minutesDiff <= 30) eventDiv.className += ' warning';
                else eventDiv.className += ' success';
                
                eventDiv.innerHTML = `
                    <strong>${event.title}</strong><br>
                    <small>Dans ${minutesDiff} minutes | Notification envoy√©e: ${event.notificationsIsSended ? 'Oui' : 'Non'}</small>
                `;
                
                eventsList.appendChild(eventDiv);
            });
        }

        // Fonction pour v√©rifier le statut des √©v√©nements
        async function checkEventStatus() {
            try {
                if (window.electron && window.electron.getDatabase) {
                    const database = await window.electron.getDatabase();
                    const testEvents = database.events?.filter(event => 
                        event.id.startsWith('test-event-')
                    ) || [];
                    
                    logMessage(`üìä ${testEvents.length} √©v√©nement(s) de test trouv√©(s)`, 'info');
                    
                    testEvents.forEach(event => {
                        const eventTime = new Date(`${event.startDate}T${event.startTime}`);
                        const now = new Date();
                        const minutesDiff = Math.floor((eventTime.getTime() - now.getTime()) / (1000 * 60));
                        
                        logMessage(`  - ${event.title}: dans ${minutesDiff} min (notif: ${event.notificationsIsSended ? 'envoy√©e' : 'en attente'})`, 'info');
                    });
                    
                    displayEvents(testEvents);
                } else {
                    logMessage('‚ö†Ô∏è API Electron non disponible', 'warning');
                }
            } catch (error) {
                logMessage(`‚ùå Erreur lors de la v√©rification: ${error.message}`, 'error');
            }
        }

        // Fonction pour nettoyer les √©v√©nements de test
        async function cleanupTestEvents() {
            try {
                if (window.electron && window.electron.getDatabase && window.electron.saveDatabase) {
                    const database = await window.electron.getDatabase();
                    
                    if (database.events) {
                        const originalCount = database.events.length;
                        database.events = database.events.filter(event => 
                            !event.id.startsWith('test-event-')
                        );
                        
                        await window.electron.saveDatabase(database);
                        const removedCount = originalCount - database.events.length;
                        logMessage(`üßπ ${removedCount} √©v√©nement(s) de test supprim√©(s)`, 'success');
                        
                        document.getElementById('events-list').innerHTML = '';
                    }
                } else {
                    logMessage('‚ö†Ô∏è API Electron non disponible', 'warning');
                }
            } catch (error) {
                logMessage(`‚ùå Erreur lors du nettoyage: ${error.message}`, 'error');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üöÄ Page de test de surveillance des √©v√©nements charg√©e', 'success');
            logMessage('‚ÑπÔ∏è Le syst√®me de surveillance v√©rifie automatiquement les √©v√©nements chaque minute', 'info');
            logMessage('‚ÑπÔ∏è Cr√©ez des √©v√©nements de test et surveillez les notifications dans l\'application principale', 'info');
        });
    </script>
</body>
</html>